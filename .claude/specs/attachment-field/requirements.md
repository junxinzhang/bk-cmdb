# 蓝鲸CMDB附件字段类型和在线预览功能需求规范

## 概述

为蓝鲸CMDB配置管理平台新增企业级附件字段类型，支持在模型字段中定义安全的附件上传字段，实现资源实例录入时的附件上传、存储、下载和在线预览功能。该功能采用本地存储方案，具备完善的安全防护、权限控制、审计跟踪和性能优化机制，确保数据安全和系统稳定。

## 功能需求

### 1. 字段类型扩展

#### 1.1 附件字段类型定义
**用户故事**: 作为模型管理员，我希望能够在模型字段类型中添加附件类型，以便支持附件上传功能。

**验收标准**:
1.1.1 **WHEN** 系统启动时，**IF** 加载字段类型定义，**THEN** 应包含 `FieldTypeAttachment` 类型并正确集成到蓝鲸CMDB的字段类型系统
1.1.2 **WHEN** 用户在模型管理界面创建字段时，**IF** 选择字段类型，**THEN** 下拉列表中应显示"附件"选项，且支持国际化显示
1.1.3 **WHEN** 选择附件字段类型时，**IF** 配置字段属性，**THEN** 应提供文件大小限制、安全文件类型白名单、最大文件数量、存储路径等配置选项
1.1.4 **WHEN** 保存附件字段配置时，**IF** 验证配置参数，**THEN** 文件大小限制应在1KB-100MB范围内，文件类型应严格限制在预定义的安全类型白名单内，并进行服务端二次验证

#### 1.2 字段属性元数据支持
**用户故事**: 作为系统开发者，我希望附件字段能够完整集成到现有的字段属性系统中，以便保持系统一致性。

**验收标准**:
1.2.1 **WHEN** 创建附件字段时，**IF** 生成字段元数据，**THEN** 应包含附件专用属性（文件大小限制、文件类型限制、是否支持多文件等）
1.2.2 **WHEN** 字段元数据存储到数据库时，**IF** 包含附件属性，**THEN** 应正确序列化为JSON格式并验证数据完整性
1.2.3 **WHEN** 系统读取附件字段元数据时，**IF** 从数据库反序列化，**THEN** 应正确解析所有附件相关属性

### 2. 附件上传功能

#### 2.1 文件上传API
**用户故事**: 作为最终用户，我希望能够在资源实例录入时上传附件文件，以便补充资源的详细信息。

**验收标准**:
2.1.1 **WHEN** 用户点击附件字段的上传按钮时，**IF** 选择本地文件，**THEN** 应支持单文件和多文件选择，并进行客户端预验证
2.1.2 **WHEN** 文件上传到服务器时，**IF** 验证文件属性，**THEN** 应检查文件大小、MIME类型真实性、文件头魔数、文件名安全性、路径遍历攻击防护
2.1.3 **WHEN** 文件验证通过时，**IF** 执行上传操作，**THEN** 应生成UUID文件ID，使用安全存储路径，计算文件MD5防篡改，返回完整文件元信息
2.1.4 **WHEN** 文件上传失败时，**IF** 发生错误，**THEN** 应使用蓝鲸CMDB标准CCError机制返回错误，记录详细审计日志包含用户ID、IP地址、时间戳

#### 2.2 文件存储管理
**用户故事**: 作为系统管理员，我希望附件文件能够安全有序地存储，以便进行后续管理和维护。

**验收标准**:
2.2.1 **WHEN** 文件上传成功时，**IF** 存储到本地文件系统，**THEN** 应按年/月/日/类型层级目录存储，设置安全权限（0644），禁止执行权限
2.2.2 **WHEN** 生成文件存储路径时，**IF** 使用UUID作为文件名，**THEN** 应确保路径安全性，防止目录遍历攻击，文件名包含随机UUID和原始扩展名
2.2.3 **WHEN** 存储文件元信息时，**IF** 记录到MongoDB，**THEN** 应包含完整元数据：文件ID、原始文件名、文件大小、真实MIME类型、MD5哈希、上传者、业务ID、存储路径、创建时间
2.2.4 **WHEN** 文件存储操作失败时，**IF** 发生磁盘空间不足等错误，**THEN** 应原子性清理所有临时文件，使用CCError标准错误码，记录完整错误上下文

#### 2.3 上传进度和状态反馈
**用户故事**: 作为最终用户，我希望能够看到文件上传的进度和状态，以便了解上传是否成功。

**验收标准**:
2.3.1 **WHEN** 开始上传文件时，**IF** 显示上传界面，**THEN** 应显示上传进度条和当前上传状态
2.3.2 **WHEN** 文件上传过程中，**IF** 实时更新进度，**THEN** 应显示上传百分比和剩余时间估算
2.3.3 **WHEN** 文件上传完成时，**IF** 上传成功，**THEN** 应显示成功提示并展示文件预览信息
2.3.4 **WHEN** 文件上传失败时，**IF** 出现错误，**THEN** 应显示错误提示和重试按钮

### 3. 附件下载功能

#### 3.1 文件下载API
**用户故事**: 作为最终用户，我希望能够下载已上传的附件文件，以便在本地查看和使用。

**验收标准**:
3.1.1 **WHEN** 用户点击文件下载链接时，**IF** 请求下载文件，**THEN** 应验证用户业务权限、实例访问权限、字段权限和文件存在性，记录访问日志
3.1.2 **WHEN** 下载权限验证通过时，**IF** 返回文件内容，**THEN** 应设置安全响应头防止XSS，正确的Content-Type和Content-Disposition，支持断点续传
3.1.3 **WHEN** 文件不存在时，**IF** 请求下载，**THEN** 应返回蓝鲸CMDB标准404错误码CCErrAttachmentFileNotFound和国际化错误提示
3.1.4 **WHEN** 用户无下载权限时，**IF** 请求下载，**THEN** 应返回CCErrAttachmentPermissionDenied错误码，记录权限拒绝审计日志

#### 3.2 批量下载支持
**用户故事**: 作为最终用户，我希望能够批量下载多个附件文件，以便提高操作效率。

**验收标准**:
3.2.1 **WHEN** 用户选择多个附件文件时，**IF** 点击批量下载，**THEN** 应将所有文件打包为ZIP格式
3.2.2 **WHEN** 生成ZIP文件时，**IF** 包含多个附件，**THEN** 应使用原始文件名并处理重名冲突
3.2.3 **WHEN** ZIP文件生成完成时，**IF** 开始下载，**THEN** 应提供下载链接并设置合适的文件名
3.2.4 **WHEN** 批量下载操作超时时，**IF** 文件数量过多，**THEN** 应提供异步下载和进度查询功能

### 4. 在线预览功能

#### 4.1 图片文件预览
**用户故事**: 作为最终用户，我希望能够在线预览图片类型的附件，以便快速查看图片内容。

**验收标准**:
4.1.1 **WHEN** 用户点击图片类型附件时，**IF** 触发预览功能，**THEN** 应在弹窗中显示图片内容
4.1.2 **WHEN** 显示图片预览时，**IF** 图片较大，**THEN** 应支持缩放、旋转、全屏查看功能
4.1.3 **WHEN** 预览多张图片时，**IF** 存在多个图片附件，**THEN** 应支持左右切换浏览
4.1.4 **WHEN** 图片加载失败时，**IF** 网络或文件错误，**THEN** 应显示加载失败提示和重试按钮

#### 4.2 PDF文件预览
**用户故事**: 作为最终用户，我希望能够在线预览PDF类型的附件，以便直接查看文档内容。

**验收标准**:
4.2.1 **WHEN** 用户点击PDF类型附件时，**IF** 触发预览功能，**THEN** 应在弹窗中显示PDF内容
4.2.2 **WHEN** 显示PDF预览时，**IF** 文档有多页，**THEN** 应支持翻页、跳转到指定页、缩放功能
4.2.3 **WHEN** PDF文件较大时，**IF** 加载时间较长，**THEN** 应显示加载进度和预览提示
4.2.4 **WHEN** PDF预览出错时，**IF** 文件损坏或格式不支持，**THEN** 应提供下载链接作为备选方案

#### 4.3 文本文件预览
**用户故事**: 作为最终用户，我希望能够在线预览文本类型的附件，以便快速查看文件内容。

**验收标准**:
4.3.1 **WHEN** 用户点击文本类型附件时，**IF** 触发预览功能，**THEN** 应在弹窗中显示文本内容
4.3.2 **WHEN** 显示文本预览时，**IF** 文件编码正确，**THEN** 应正确显示中文和特殊字符
4.3.3 **WHEN** 文本文件较大时，**IF** 内容超过预览限制，**THEN** 应显示部分内容并提供下载完整文件的选项
4.3.4 **WHEN** 文本编码识别失败时，**IF** 出现乱码，**THEN** 应提供编码选择选项或直接提供下载链接

### 5. 前端用户界面

#### 5.1 附件字段表单组件
**用户故事**: 作为最终用户，我希望能够通过直观的界面操作附件上传功能，以便轻松管理附件文件。

**验收标准**:
5.1.1 **WHEN** 在资源实例编辑页面时，**IF** 遇到附件字段，**THEN** 应显示专用的附件上传组件
5.1.2 **WHEN** 附件组件加载时，**IF** 字段已有附件，**THEN** 应显示已上传文件的列表和预览信息
5.1.3 **WHEN** 用户拖拽文件到上传区域时，**IF** 文件格式支持，**THEN** 应高亮显示并准备上传
5.1.4 **WHEN** 上传组件显示文件列表时，**IF** 包含多个文件，**THEN** 应显示文件名、大小、类型、上传时间等信息

#### 5.2 文件预览弹窗组件
**用户故事**: 作为最终用户，我希望通过弹窗预览附件内容，以便在不离开当前页面的情况下查看文件。

**验收标准**:
5.2.1 **WHEN** 用户点击预览按钮时，**IF** 打开预览弹窗，**THEN** 应根据文件类型选择合适的预览方式
5.2.2 **WHEN** 预览弹窗显示时，**IF** 内容加载完成，**THEN** 应提供关闭、下载、全屏等操作按钮
5.2.3 **WHEN** 预览弹窗中有多个文件时，**IF** 用户切换文件，**THEN** 应平滑切换并更新预览内容
5.2.4 **WHEN** 预览弹窗关闭时，**IF** 用户点击关闭或按ESC键，**THEN** 应正确清理资源并关闭弹窗

#### 5.3 文件类型图标和状态显示
**用户故事**: 作为最终用户，我希望能够通过图标和状态快速识别附件类型和状态，以便提高操作效率。

**验收标准**:
5.3.1 **WHEN** 显示附件列表时，**IF** 包含不同类型文件，**THEN** 应为每种文件类型显示对应的图标
5.3.2 **WHEN** 文件正在上传时，**IF** 显示文件状态，**THEN** 应显示上传中的动画图标和进度信息
5.3.3 **WHEN** 文件上传失败时，**IF** 显示错误状态，**THEN** 应显示错误图标和错误信息提示
5.3.4 **WHEN** 文件可以预览时，**IF** 支持在线预览，**THEN** 应显示预览按钮并高亮预览功能

### 6. 系统集成和兼容性

#### 6.1 现有系统集成
**用户故事**: 作为系统管理员，我希望附件功能能够无缝集成到现有系统中，以便不影响现有功能的正常使用。

**验收标准**:
6.1.1 **WHEN** 系统升级后，**IF** 现有模型字段正常工作，**THEN** 新增的附件字段类型不应影响其他字段功能
6.1.2 **WHEN** 导入导出功能运行时，**IF** 包含附件字段的模型，**THEN** 应正确处理附件字段的导入导出逻辑
6.1.3 **WHEN** 权限系统验证时，**IF** 涉及附件相关操作，**THEN** 应正确集成到现有权限管理体系
6.1.4 **WHEN** API接口调用时，**IF** 通过REST API操作附件，**THEN** 应保持与现有API风格的一致性

#### 6.2 数据库兼容性
**用户故事**: 作为数据库管理员，我希望附件功能的数据库变更能够平滑升级，以便保证数据安全和系统稳定。

**验收标准**:
6.2.1 **WHEN** 数据库升级时，**IF** 添加附件相关表结构，**THEN** 应提供完整的升级脚本和回滚方案
6.2.2 **WHEN** 现有数据迁移时，**IF** 包含附件字段的模型，**THEN** 应正确处理空值和默认值
6.2.3 **WHEN** 数据库备份时，**IF** 包含附件元信息，**THEN** 应确保附件元数据的完整性
6.2.4 **WHEN** 数据库性能测试时，**IF** 大量附件元数据查询，**THEN** 应保持查询性能在可接受范围内

### 7. 安全性和权限控制

#### 7.1 文件上传安全
**用户故事**: 作为安全管理员，我希望文件上传功能具备完善的安全防护，以便防止恶意文件上传和系统攻击。

**验收标准**:
7.1.1 **WHEN** 用户上传文件时，**IF** 进行文件内容检查，**THEN** 应验证文件头魔数匹配真实类型，检测可执行文件，进行病毒扫描，验证文件完整性
7.1.2 **WHEN** 文件存储时，**IF** 生成存储路径，**THEN** 应防止路径遍历攻击（../ ./），使用UUID文件名，限制在指定存储目录内，设置安全文件权限
7.1.3 **WHEN** 执行文件操作时，**IF** 处理用户输入，**THEN** 应对文件名进行严格过滤，移除特殊字符，限制长度，防止SQL注入和命令注入
7.1.4 **WHEN** 文件访问时，**IF** 提供访问链接，**THEN** 应使用带过期时间的JWT令牌，记录访问审计日志，实现访问频率限制

#### 7.2 权限控制集成
**用户故事**: 作为权限管理员，我希望附件功能能够集成到现有权限体系中，以便精确控制用户的附件操作权限。

**验收标准**:
7.2.1 **WHEN** 用户尝试上传附件时，**IF** 验证权限，**THEN** 应检查用户是否有该资源实例的编辑权限
7.2.2 **WHEN** 用户尝试下载附件时，**IF** 验证权限，**THEN** 应检查用户是否有该资源实例的查看权限
7.2.3 **WHEN** 用户尝试删除附件时，**IF** 验证权限，**THEN** 应检查用户是否有该资源实例的删除权限
7.2.4 **WHEN** 权限配置变更时，**IF** 影响附件相关权限，**THEN** 应立即生效并正确限制用户操作

### 8. 性能和存储优化

#### 8.1 文件存储优化
**用户故事**: 作为系统管理员，我希望附件存储能够高效利用存储空间，以便降低存储成本和提高系统性能。

**验收标准**:
8.1.1 **WHEN** 存储相同文件时，**IF** 文件内容相同，**THEN** 应实现文件去重以节省存储空间
8.1.2 **WHEN** 文件数量增长时，**IF** 目录结构过深，**THEN** 应按时间和类型合理分目录存储
8.1.3 **WHEN** 清理无效文件时，**IF** 附件引用关系失效，**THEN** 应提供清理工具删除孤立文件
8.1.4 **WHEN** 监控存储使用时，**IF** 存储空间不足，**THEN** 应提供存储使用情况统计和告警功能

#### 8.2 访问性能优化
**用户故事**: 作为最终用户，我希望附件访问速度快，以便提高工作效率和用户体验。

**验收标准**:
8.2.1 **WHEN** 访问附件文件时，**IF** 文件较大，**THEN** 应支持断点续传和分块下载
8.2.2 **WHEN** 预览文件时，**IF** 文件尺寸较大，**THEN** 应生成缩略图或预览版本以提高加载速度
8.2.3 **WHEN** 并发访问时，**IF** 多用户同时下载，**THEN** 应优化文件I/O操作避免性能瓶颈
8.2.4 **WHEN** 缓存策略执行时，**IF** 静态文件访问，**THEN** 应设置合适的缓存头以提高访问效率

## 非功能性需求

### 9. 技术约束和质量要求

#### 9.1 技术栈兼容性
9.1.1 后端服务必须使用Go 1.20和蓝鲸CMDB现有框架实现，集成到coreservice微服务架构，遵循分层设计原则
9.1.2 前端组件必须基于Vue.js 2.7和bk-magicbox组件库开发，保持UI设计规范一致性，支持国际化
9.1.3 数据存储必须使用MongoDB集群，文件存储使用本地文件系统，支持分布式部署和负载均衡
9.1.4 API设计必须遵循蓝鲸CMDB RESTful规范，使用标准CCError错误码，保持响应格式一致性

#### 9.2 性能要求
9.2.1 单文件上传大小限制为100MB，批量上传文件数量限制为20个
9.2.2 文件预览响应时间应在3秒内，下载启动时间应在1秒内
9.2.3 并发文件上传数量应支持100个用户同时操作
9.2.4 附件元数据查询响应时间应在500毫秒内

#### 9.3 安全要求  
9.3.1 文件类型白名单严格限制：图片（jpg、jpeg、png、gif、bmp、webp）、文档（pdf、txt）、压缩包（zip），基于文件头魔数验证
9.3.2 文件上传必须进行多层安全检查：MIME类型验证、文件头验证、病毒扫描、恶意代码检测、文件大小和内容完整性校验
9.3.3 所有文件访问必须通过蓝鲸CMDB权限系统验证，实现业务级数据隔离，记录完整访问审计日志，不得提供直接文件系统访问
9.3.4 文件存储实现沙箱隔离，路径必须在指定目录内，防止路径遍历攻击，文件权限设置为只读，禁止执行权限

### 10. 错误处理和日志记录

#### 10.1 标准化错误处理
10.1.1 所有错误必须使用蓝鲸CMDB标准CCError错误码机制，定义专用附件错误码范围1199200-1199299
10.1.2 错误信息必须支持国际化，提供中英文错误描述
10.1.3 错误响应格式必须与蓝鲸CMDB API标准格式保持一致
10.1.4 临界错误必须触发告警机制，记录到系统监控平台

#### 10.2 审计和日志要求
10.2.1 所有文件操作必须记录审计日志：用户ID、IP地址、操作类型、文件ID、时间戳、操作结果
10.2.2 安全事件必须记录到安全日志：权限拒绝、恶意文件检测、异常访问模式
10.2.3 性能日志必须记录关键指标：上传下载耗时、文件大小、并发数量
10.2.4 日志必须支持结构化格式，便于日志分析和监控告警集成

### 11. 测试和质量保证

#### 11.1 测试覆盖要求
11.1.1 单元测试覆盖率必须达到90%以上，包含所有核心业务逻辑和边界条件
11.1.2 集成测试必须覆盖完整的文件上传下载流程，验证与现有系统的兼容性
11.1.3 安全测试必须包含：恶意文件上传、路径遍历攻击、权限绕过、注入攻击等
11.1.4 性能测试必须验证：大文件处理、高并发场景、存储空间限制、内存泄漏等

#### 11.2 代码质量标准
11.2.1 代码必须通过静态分析工具检查，无严重和高危漏洞
11.2.2 前端代码必须实现内存管理，防止内存泄漏，支持组件销毁时资源清理
11.2.3 后端代码必须实现优雅关闭，支持健康检查接口
11.2.4 所有公开API必须有完整的文档和使用示例

### 12. 环境和部署要求

#### 12.1 存储要求
12.1.1 本地存储路径：/data/attachments/，需要足够的磁盘空间和严格的权限控制(755目录，644文件)
12.1.2 存储目录结构：按年/月/日/类型分层存储，支持自动清理和归档机制
12.1.3 文件备份策略：支持增量备份，数据完整性校验，快速恢复机制
12.1.4 存储监控：实时监控磁盘使用率、IO性能、文件访问频率，支持告警阈值配置

#### 12.2 部署集成
12.2.1 必须与蓝鲸CMDB微服务架构无缝集成，支持服务发现和配置中心
12.2.2 必须支持多实例部署和负载均衡，实现高可用架构
12.2.3 必须通过现有的CI/CD流程进行部署，支持蓝绿部署和回滚
12.2.4 必须支持容器化部署，与现有K8s环境兼容

#### 12.3 监控和运维
12.3.1 必须提供完整的监控指标：请求量、响应时间、错误率、资源使用率
12.3.2 必须集成到现有告警系统，支持关键指标阈值告警
12.3.3 必须提供运维友好的管理接口：存储清理、缓存清理、配置热更新
12.3.4 必须支持分布式链路追踪，便于故障定位和性能优化