# 蓝鲸CMDB附件字段类型和在线预览功能实现任务清单

## 第一阶段：基础功能实现 (2-3周)

### 1. 后端字段类型扩展
- [ ] 1.1 扩展字段类型定义
  - 在 `src/common/definitions.go` 中添加 `FieldTypeAttachment` 常量
  - 更新 `FieldTypes` 数组包含新的附件类型
  - 定义附件字段配置选项结构体 `AttachmentOption`
  - **参考需求**: 1.1.1, 1.1.2, 1.1.3, 1.1.4

- [ ] 1.2 创建附件元数据模型
  - 新建 `src/common/metadata/attachment.go` 文件
  - 定义 `AttachmentMeta` 结构体用于存储文件元信息
  - 定义 `AttachmentValue` 结构体用于存储字段值
  - 添加必要的JSON和BSON标签
  - **参考需求**: 1.2.1, 1.2.2, 1.2.3

- [ ] 1.3 扩展字段验证系统
  - 在 `src/common/metadata/attribute.go` 中添加附件字段验证函数
  - 实现 `validAttachment` 方法验证附件字段值
  - 实现 `getAttachmentOption` 方法解析字段配置
  - 验证文件数量、大小限制等规则
  - **参考需求**: 1.1.4, 1.2.3

- [ ] 1.4 数据库表结构设计
  - 创建附件元数据表 `cc_attachment_meta` 索引
  - 设计表字段结构包含文件ID、路径、大小等信息
  - 创建必要的数据库索引优化查询性能
  - **参考需求**: 6.2.1, 6.2.2, 6.2.3, 6.2.4

### 2. 文件存储管理器实现
- [ ] 2.1 创建文件存储管理器
  - 新建 `src/web_server/service/attachment/storage.go`
  - 实现 `StorageManager` 结构体
  - 实现按日期和类型分目录存储逻辑
  - 实现文件保存、获取、删除方法
  - **参考需求**: 2.2.1, 2.2.2, 2.2.3, 2.2.4

- [ ] 2.2 实现文件安全处理
  - 实现文件类型验证（基于文件头魔数）
  - 实现文件名安全化处理
  - 实现文件MD5计算和去重检查
  - 添加文件权限和访问控制
  - **参考需求**: 7.1.1, 7.1.2, 7.1.3, 7.1.4

- [ ] 2.3 配置存储目录结构
  - 创建 `/data/attachments` 基础目录结构
  - 按年/月/日/类型创建子目录
  - 设置合适的文件系统权限
  - 配置存储路径和临时目录
  - **参考需求**: 10.1.1, 10.1.2

### 3. 附件服务API实现
- [ ] 3.1 创建附件服务接口
  - 新建 `src/web_server/service/attachment.go`
  - 定义 `AttachmentService` 接口
  - 定义请求响应数据结构
  - 实现依赖注入和初始化逻辑
  - **参考需求**: 2.1.1, 2.1.2, 2.1.3, 2.1.4

- [ ] 3.2 实现文件上传API
  - 实现 `POST /api/v3/attachment/upload` 接口
  - 支持 multipart/form-data 文件上传
  - 添加文件大小、类型、数量验证
  - 实现权限验证和业务ID检查
  - **参考需求**: 2.1.1, 2.1.2, 2.1.3, 2.1.4

- [ ] 3.3 实现文件下载API
  - 实现 `GET /api/v3/attachment/download/{file_id}` 接口
  - 支持文件流式下载
  - 设置正确的响应头和MIME类型
  - 添加权限验证和访问控制
  - **参考需求**: 3.1.1, 3.1.2, 3.1.3, 3.1.4

- [ ] 3.4 实现文件管理API
  - 实现文件信息查询接口
  - 实现文件删除接口
  - 实现批量操作接口
  - 添加错误处理和日志记录
  - **参考需求**: 3.2.1, 3.2.2, 3.2.3, 3.2.4

### 4. 前端附件字段组件
- [ ] 4.1 创建附件表单组件
  - 新建 `src/ui/src/components/ui/form/attachment.vue`
  - 实现文件上传界面和拖拽功能
  - 实现文件列表显示和状态管理
  - 添加上传进度和错误处理
  - **参考需求**: 5.1.1, 5.1.2, 5.1.3, 5.1.4

- [ ] 4.2 实现文件操作功能
  - 实现文件上传前验证（大小、类型、数量）
  - 实现上传进度显示和状态反馈
  - 实现文件删除和批量操作
  - 添加错误提示和用户引导
  - **参考需求**: 2.3.1, 2.3.2, 2.3.3, 2.3.4

- [ ] 4.3 集成到表单系统
  - 将附件组件注册到表单组件系统
  - 实现与现有表单验证系统集成
  - 支持字段配置选项传递
  - 确保与其他字段类型兼容性
  - **参考需求**: 6.1.1, 6.1.2, 6.1.3, 6.1.4

- [ ] 4.4 创建工具类和常量
  - 新建 `attachment-constants.js` 定义文件类型图标映射
  - 实现文件大小格式化工具函数
  - 定义支持的文件类型和预览类型
  - 添加文件操作通用方法
  - **参考需求**: 5.3.1, 5.3.2, 5.3.3, 5.3.4

### 5. 权限集成和安全控制
- [ ] 5.1 集成现有权限系统
  - 实现附件操作权限检查
  - 集成到实例编辑权限验证
  - 添加字段级别权限控制
  - 确保与IAM系统兼容
  - **参考需求**: 7.2.1, 7.2.2, 7.2.3, 7.2.4

- [ ] 5.2 实现访问控制
  - 实现基于业务ID的数据隔离
  - 添加文件访问日志记录
  - 实现安全的文件访问链接
  - 防止未授权文件访问
  - **参考需求**: 7.1.4, 7.2.1, 7.2.2

### 6. 基础测试和调试
- [ ] 6.1 后端单元测试
  - 编写存储管理器测试用例
  - 编写附件服务API测试用例
  - 编写字段验证测试用例
  - 确保测试覆盖率达到80%以上
  - **参考需求**: 所有后端功能需求

- [ ] 6.2 前端组件测试
  - 编写附件组件单元测试
  - 测试文件上传和验证逻辑
  - 测试用户交互和错误处理
  - 确保组件在不同浏览器中正常工作
  - **参考需求**: 所有前端功能需求

## 第二阶段：预览功能实现 (1-2周)

### 7. 文件预览服务
- [ ] 7.1 创建预览服务
  - 新建 `src/web_server/service/attachment/preview.go`
  - 实现 `PreviewService` 结构体
  - 定义预览数据结构和接口
  - 实现预览类型判断逻辑
  - **参考需求**: 4.1.1, 4.1.2, 4.1.3, 4.1.4

- [ ] 7.2 实现图片预览
  - 实现图片预览数据生成
  - 支持获取图片尺寸信息
  - 实现图片缩略图生成
  - 添加图片格式兼容性处理
  - **参考需求**: 4.1.1, 4.1.2, 4.1.3, 4.1.4

- [ ] 7.3 实现PDF预览
  - 实现PDF预览数据返回
  - 集成PDF.js预览方案
  - 支持PDF页数和基本信息获取
  - 处理PDF预览错误情况
  - **参考需求**: 4.2.1, 4.2.2, 4.2.3, 4.2.4

- [ ] 7.4 实现文本预览
  - 实现文本文件内容读取
  - 支持多种文本编码格式
  - 实现大文件部分预览功能
  - 添加文本内容安全过滤
  - **参考需求**: 4.3.1, 4.3.2, 4.3.3, 4.3.4

### 8. 预览API接口
- [ ] 8.1 实现预览API
  - 实现 `GET /api/v3/attachment/preview/{file_id}` 接口
  - 支持不同文件类型的预览数据返回
  - 添加预览缓存机制
  - 实现预览权限验证
  - **参考需求**: 4.1.1, 4.2.1, 4.3.1

- [ ] 8.2 优化预览性能
  - 实现预览数据缓存
  - 添加并发预览限制
  - 优化大文件预览处理
  - 实现预览超时控制
  - **参考需求**: 8.2.1, 8.2.2, 8.2.3, 8.2.4

### 9. 前端预览功能
- [ ] 9.1 创建预览弹窗组件
  - 新建 `attachment-preview-modal.vue`
  - 实现模态框布局和交互
  - 支持多文件切换预览
  - 添加预览工具栏功能
  - **参考需求**: 5.2.1, 5.2.2, 5.2.3, 5.2.4

- [ ] 9.2 实现图片预览功能
  - 实现图片缩放、旋转功能
  - 支持图片全屏预览
  - 添加图片导航控制
  - 实现图片加载错误处理
  - **参考需求**: 4.1.1, 4.1.2, 4.1.3, 4.1.4

- [ ] 9.3 实现PDF预览功能
  - 集成PDF.js库到项目
  - 实现PDF内嵌预览界面
  - 支持PDF翻页和缩放
  - 添加PDF加载进度显示
  - **参考需求**: 4.2.1, 4.2.2, 4.2.3, 4.2.4

- [ ] 9.4 实现文本预览功能
  - 实现文本内容显示组件
  - 支持语法高亮和格式化
  - 处理大文件截断显示
  - 提供完整文件下载选项
  - **参考需求**: 4.3.1, 4.3.2, 4.3.3, 4.3.4

### 10. 文件类型图标和状态
- [ ] 10.1 实现文件类型图标
  - 创建文件类型图标映射表
  - 实现根据扩展名显示对应图标
  - 添加默认文件图标
  - 确保图标在不同主题下显示正常
  - **参考需求**: 5.3.1, 5.3.2, 5.3.3, 5.3.4

- [ ] 10.2 实现文件状态显示
  - 实现上传中动画效果
  - 添加上传失败错误状态
  - 显示文件预览可用性
  - 实现状态图标和提示文字
  - **参考需求**: 5.3.1, 5.3.2, 5.3.3, 5.3.4

## 第三阶段：功能增强和优化 (1-2周)

### 11. 批量操作功能
- [ ] 11.1 实现批量上传
  - 支持多文件同时选择上传
  - 实现拖拽批量上传功能
  - 添加批量上传进度显示
  - 处理批量上传错误情况
  - **参考需求**: 2.3.1, 2.3.2, 2.3.3, 2.3.4

- [ ] 11.2 实现批量下载
  - 实现 `POST /api/v3/attachment/batch-download` 接口
  - 支持多文件打包ZIP下载
  - 实现异步批量下载任务
  - 添加下载进度查询接口
  - **参考需求**: 3.2.1, 3.2.2, 3.2.3, 3.2.4

- [ ] 11.3 优化批量操作用户体验
  - 添加批量选择和全选功能
  - 实现批量操作确认对话框
  - 优化批量操作反馈提示
  - 支持批量操作的取消功能
  - **参考需求**: 5.1.1, 5.1.2, 5.1.3, 5.1.4

### 12. 性能优化
- [ ] 12.1 实现文件去重
  - 基于MD5哈希实现文件去重
  - 减少重复文件存储空间占用
  - 优化去重查询性能
  - 处理去重文件的引用计数
  - **参考需求**: 8.1.1, 8.1.2, 8.1.3, 8.1.4

- [ ] 12.2 优化上传下载性能
  - 实现文件分块上传功能
  - 支持断点续传和重试机制
  - 优化大文件上传下载性能
  - 实现并发上传下载控制
  - **参考需求**: 8.2.1, 8.2.2, 8.2.3, 8.2.4

- [ ] 12.3 实现缓存机制
  - 添加文件预览数据缓存
  - 实现文件元信息缓存
  - 优化数据库查询性能
  - 添加缓存失效和更新机制
  - **参考需求**: 8.2.1, 8.2.2, 8.2.3, 8.2.4

### 13. 存储管理和清理
- [ ] 13.1 实现存储监控
  - 实现存储空间使用统计
  - 添加存储空间告警功能
  - 监控文件访问频率和热度
  - 提供存储使用报表
  - **参考需求**: 8.1.4, 10.1.4

- [ ] 13.2 实现文件清理
  - 实现孤立文件清理功能
  - 支持已删除文件定期清理
  - 添加临时文件自动清理
  - 实现存储空间回收机制
  - **参考需求**: 8.1.3, 10.1.3

- [ ] 13.3 实现备份和恢复
  - 设计文件备份策略
  - 实现增量备份功能
  - 支持文件恢复和迁移
  - 添加备份验证和监控
  - **参考需求**: 10.1.3, 10.2.3

### 14. 系统集成和兼容性
- [ ] 14.1 数据导入导出集成
  - 集成到现有导入导出功能
  - 支持附件字段的Excel导入导出
  - 处理导入导出时的文件关联
  - 确保数据一致性和完整性
  - **参考需求**: 6.1.2, 6.1.3, 6.1.4

- [ ] 14.2 API兼容性保证
  - 确保与现有REST API风格一致
  - 保持向后兼容性
  - 添加API版本控制
  - 完善API文档和示例
  - **参考需求**: 6.1.4, 6.2.4

- [ ] 14.3 UI主题兼容性
  - 确保组件在不同主题下正常显示
  - 适配深色主题和高对比度主题
  - 优化移动端显示效果
  - 保持与现有UI设计风格一致
  - **参考需求**: 6.1.1, 6.1.2

### 15. 测试和质量保证
- [ ] 15.1 完善单元测试
  - 补充所有新功能的单元测试
  - 确保测试覆盖率达到90%以上
  - 添加边界条件和异常情况测试
  - 实现自动化测试持续集成
  - **参考需求**: 所有功能需求

- [ ] 15.2 集成测试
  - 编写端到端功能测试用例
  - 测试文件上传下载完整流程
  - 验证权限控制和安全机制
  - 测试系统在高负载下的表现
  - **参考需求**: 所有功能需求

- [ ] 15.3 性能测试
  - 进行大文件上传下载性能测试
  - 测试并发操作性能极限
  - 验证存储空间使用效率
  - 评估系统资源消耗情况
  - **参考需求**: 9.2.1, 9.2.2, 9.2.3, 9.2.4

- [ ] 15.4 安全测试
  - 进行文件上传安全测试
  - 验证权限控制有效性
  - 测试恶意文件检测能力
  - 评估数据泄露风险
  - **参考需求**: 7.1.1, 7.1.2, 7.1.3, 7.1.4

### 16. 文档和部署准备
- [ ] 16.1 编写技术文档
  - 完善API接口文档
  - 编写组件使用说明
  - 创建部署和配置指南
  - 提供故障排查手册
  - **参考需求**: 10.2.1, 10.2.2, 10.2.3, 10.2.4

- [ ] 16.2 配置管理
  - 创建生产环境配置模板
  - 添加配置验证和检查
  - 实现配置热更新功能
  - 提供配置最佳实践建议
  - **参考需求**: 10.1.1, 10.1.2, 10.1.3, 10.1.4

- [ ] 16.3 监控和告警
  - 添加关键指标监控
  - 实现异常情况告警
  - 创建运维监控面板
  - 提供性能调优建议
  - **参考需求**: 所有非功能性需求

- [ ] 16.4 上线准备
  - 准备数据库迁移脚本
  - 创建部署自动化脚本
  - 进行灰度发布测试
  - 制定回滚应急预案
  - **参考需求**: 10.2.1, 10.2.2, 10.2.3, 10.2.4

## 里程碑检查点

### 第一阶段完成标准 (2-3周后)
- [x] 所有后端基础API接口可正常工作
- [x] 前端附件组件可以上传、显示、删除文件
- [x] 权限控制和安全验证有效
- [x] 基础测试用例通过率达到80%以上
- [x] 可以在开发环境完整演示基本功能

### 第二阶段完成标准 (4-5周后)
- [x] 图片、PDF、文本文件预览功能正常
- [x] 预览弹窗交互体验良好
- [x] 文件类型图标和状态显示完整
- [x] 预览相关API性能满足要求
- [x] 可以演示完整的预览功能流程

### 第三阶段完成标准 (5-7周后)
- [x] 批量操作功能稳定可用
- [x] 性能优化效果明显
- [x] 存储管理功能完善
- [x] 系统集成无兼容性问题
- [x] 所有测试用例通过，质量达到生产标准
- [x] 文档完整，可以支持生产环境部署

## 风险控制和应急预案

### 技术风险
- **文件存储空间不足**: 实现存储监控和自动清理机制
- **大文件上传性能问题**: 采用分块上传和异步处理
- **并发访问导致系统不稳定**: 实现并发控制和流量限制
- **文件格式兼容性问题**: 建立文件类型白名单和验证机制

### 进度风险  
- **开发时间超预期**: 优先保证核心功能，延后非关键特性
- **测试发现重大缺陷**: 预留缓冲时间用于修复和重测
- **第三方依赖问题**: 准备替代方案和降级策略
- **人员变动影响**: 保持良好的代码文档和知识传承

### 质量风险
- **安全漏洞**: 进行安全评审和渗透测试
- **性能不达标**: 进行压力测试和性能调优
- **用户体验问题**: 进行用户测试和界面优化
- **数据丢失风险**: 实现完善的备份和恢复机制